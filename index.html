<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PENILAIAN PEKAN EVALUASI - SD GRACIA 2</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
    :root{
        --bg: #f2f6fb; /* page background */
        --card: #ffffff;
        --blue-pastel: #d9ecff;
        --blue-600: #3b82f6;
    }
    body{ background: var(--bg); font-family: system-ui, sans-serif; padding:18px; }

    .page { display:none; padding:20px; background:var(--card); border-radius:12px; box-shadow:0 4px 14px rgba(0,0,0,0.08); }
    .active { display:block; }

    /* table page 1 (Data Siswa) */
    .table thead th { background: var(--blue-pastel); font-weight:700; }

    .nav-tabs { margin-bottom:18px; }

    /* >>>>>> CSS BARU UNTUK INPUT TABEL <<<<<< */
    .input-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    .input-table th { background: #e6f0ff; font-size: 0.8rem; padding: 8px 4px; text-align: center; border: 1px solid #cce0ff; }
    .input-table td { border: 1px solid #cce0ff; padding: 0; vertical-align: top; }
    .input-table tbody tr:hover { background: #f9fcff; }
    
    .mapel-cell { padding: 4px; text-align: center; }
    .mapel-cell .pe-input-group {
        display: flex;
        flex-direction: column; /* Input PE kembali vertikal di dalam cell Mapel */
        gap: 2px;
        margin: 0;
    }
    .mapel-cell .pe-item {
        flex-grow: 1;
        text-align: center;
        padding: 0;
    }
    .mapel-cell .pe-item label {
        display: none; /* Sembunyikan label PE1, PE2, PE3 di dalam sel tabel */
    }

    .nilai-box { 
        border: none;
        padding: 4px 6px;
        margin: 0;
        border-radius: 0;
        width: 100%;
        box-sizing: border-box;
        font-size: 0.85rem;
        text-align: center;
        background: transparent;
    }
    .nilai-box:focus {
        background: #fff;
        outline: 1px solid var(--blue-600);
    }
    
    .mapel-title-rotated {
        writing-mode: vertical-rl;
        transform: rotate(180deg);
        white-space: nowrap;
        height: 120px; /* Atur tinggi header */
        line-height: 1.1;
        padding: 8px 4px;
        font-weight: 700;
        font-size: 0.75rem;
    }
    
    .header-pe {
        font-size: 0.8rem;
        font-weight: 500;
        color: #3b82f6;
    }

    /* Table body styles */
    .nama-cell { 
        text-align: left !important; 
        font-weight: 600; 
        padding: 8px !important;
        font-size: 0.9rem;
        vertical-align: middle !important;
    }
    .no-cell { 
        text-align: center; 
        width: 30px; 
        vertical-align: middle !important;
        font-size: 0.9rem;
    }
    .action-cell {
        width: 100px;
        text-align: center;
        vertical-align: middle !important;
        padding: 4px !important;
    }
    
    /* Tombol Simpan/Print di dalam sel */
    .input-table .btn-sm {
        padding: 0.1rem 0.3rem;
        font-size: 0.7rem;
        margin-bottom: 2px;
        width: 90%;
    }

    /* >>>>>> CSS PRINT MODIFIKASI <<<<<< */
    @media print{
        body{ background: #fff; }
        .nav, .btn, .nav-tabs { display:none !important; }
        .page { box-shadow:none; }
        .print-header{ background: linear-gradient(90deg, #d9ecff 0%, #eef8ff 100%); padding:12px; border-radius:8px; text-align:center; margin-bottom:12px; border:1px solid #cfe8ff; color: #004d99; }
        /* CSS print lainnya (dipertahankan dari revisi sebelumnya) */
        .meta{ margin-top:10px; display:grid; grid-template-columns: 1fr 1fr; gap:6px 22px; margin-bottom: 20px; }
        .meta .item{ font-size:14px; }
        .meta .label{ font-weight:700; width:110px; display:inline-block; }
        table{ width:100%; border-collapse:collapse; margin-top:12px; }
        table th, table td{ border:1px solid #99c2ff; padding:8px; text-align:left; font-size: 14px; }
        table thead th{ background: #b3d9ff; font-weight:700; text-align: center; }
        table td.mapel-col { width: 45%; text-align: left; }
        table td.nilai-col { width: 15%; text-align: center; }
        .signatures { display: flex; justify-content: space-between; margin-top: 40px; font-size: 14px; }
        .signature-box { text-align: center; width: 40%; }
        .signature-line { margin-top: 60px; border-bottom: 1px solid #333; display: inline-block; width: 100%; }
        /* .small-note sudah dihapus/dibiarkan kosong */
    }

    /* small screens adjust mapel flex */
    @media (max-width:720px){
        .mapel-item { flex: 1 1 calc(50% - 10px); }
    }
    @media (max-width:420px){
        .mapel-item { flex: 1 1 100%; }
    }

</style>
</head>
<body>

<ul class="nav nav-tabs mb-3">
    <li class="nav-item"><button class="nav-link active" onclick="showPage(1)">Halaman 1 - Data Siswa</button></li>
    <li class="nav-item"><button class="nav-link" onclick="showPage(2)">Halaman 2 - Input Nilai (Kelas 1)</button></li>
    <li class="nav-item"><button class="nav-link" onclick="showPage(3)">Halaman 3 - Input Nilai (Kelas 2)</button></li>
</ul>

<div id="page1" class="page active">

    <h3 class="text-center fw-bold mb-0">PENILAIAN PEKAN EVALUASI</h3>
    <p class="text-center mb-4">SD GRACIA 2 BANDUNG <br> JL. Pargasih no.256, Jamika, Kota Bandung</p>

    <table class="table table-bordered text-center align-middle">
        <thead>
            <tr>
                <th>No</th>
                <th>Nama</th>
                <th>Kelas</th>
                <th>NIS</th>
                <th>NISN</th>
                <th>Aksi</th>
            </tr>
        </thead>
        <tbody id="dataTable"></tbody>
    </table>
</div>

<div id="page2" class="page">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-bold mb-0">INPUT NILAI - KELAS 1</h4>
        <div><button class="btn btn-outline-secondary" onclick="loadAllFromStorage()">Muat dari LocalStorage</button></div>
    </div>
    <div id="kelas1"></div>
</div>

<div id="page3" class="page">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-bold mb-0">INPUT NILAI - KELAS 2</h4>
        <div><button class="btn btn-outline-secondary" onclick="loadAllFromStorage()">Muat dari LocalStorage</button></div>
    </div>
    <div id="kelas2"></div>
</div>

<script>
/* =================== DATA SISWA & MAPEL =================== */

const sekolah = {
    nama: "SD GRACIA 2 BANDUNG",
    alamat: "JL. Pargasih no.256, Jamika, Kota Bandung",
    tahunAjaran: "2024 / 2025"
};

const kelas1 = [
    { nama: "KHENSI RAFALDI PRIYADI", nis: "252601001", nisn: "-" },
    { nama: "KIMBERLY BELLVANIA HERYANTO", nis: "252601002", nisn: "317378079" },
    { nama: "YOSIA CHARISDEO DEIS", nis: "252601008", nisn: "-" }
];

const kelas2 = [
    { nama: "STELLA ANGELINA YANUBI", nis: "242501003", nisn: "3176946273" },
    { nama: "FADHIL BAYU AQIRIN", nis: "252602006", nisn: "-" },
    { nama: "GWYNETH TANUWIDJAJA", nis: "252602004", nisn: "3169999681" }
];

const mapelKelas1 = [
"PENDIDIKAN AGAMA DAN BUDI PEKERTI","PENDIDIKAN PANCASILA","BAHASA INDONESIA","MATEMATIKA",
"PJOK","SENI BUDAYA DAN PRAKARYA","BAHASA SUNDA","PENDIDIKAN LINGKUNGAN HIDUP","BAHASA INGGRIS","TIK"
];

const mapelKelas2 = [
"PENDIDIKAN AGAMA DAN BUDI PEKERTI","PENDIDIKAN PANCASILA","BAHASA INDONESIA","MATEMATIKA",
"PJOK","SENI BUDAYA DAN PRAKARYA","BAHASA SUNDA","PENDIDIKAN LINGKUNGAN HIDUP",
"BAHASA INGGRIS","TIK","PRAMUKA"
];

const peList = ["PE1","PE2","PE3"];

/* ========== HELPERS ========== */

function sanitizeId(str){
    return str.trim().replace(/\s+/g,'_').replace(/[^a-zA-Z0-9_\-]/g,'');
}

/* =================== PAGINATION / NAV =================== */

function showPage(n){
    document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
    document.getElementById("page"+n).classList.add("active");
    document.querySelectorAll(".nav-link").forEach((el,i)=> el.classList.toggle("active", i===n-1));
}

/* =================== RENDER HALAMAN 1 =================== */

function renderTable(){
    const tbody = document.getElementById("dataTable");
    tbody.innerHTML = "";
    let i=1;
    [...kelas1, ...kelas2].forEach(s => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${i++}</td>
            <td class="text-start">${s.nama}</td>
            <td>${ kelas1.find(x=>x.nis===s.nis)? "1":"2" }</td>
            <td>${s.nis}</td>
            <td>${s.nisn}</td>
            <td>
                <button class="btn btn-sm btn-primary me-1" onclick="printStudent('${s.nis}')">Print</button>
                <button class="btn btn-sm btn-success" onclick="openStudentInput('${s.nis}')">Buka Input</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

/* buka halaman input sesuai kelas dan scroll ke siswa */
function openStudentInput(nis){
    const isK1 = kelas1.find(s=>s.nis===nis);
    if(isK1){ showPage(2); }
    else { showPage(3); }
    // Di format tabel, tidak perlu scroll ke card
}

/* =================== RENDER HALAMAN 2 & 3 (INPUT TABEL BARU) =================== */

function renderInput(){
    renderKelasDiv("kelas1", kelas1, mapelKelas1, 1);
    renderKelasDiv("kelas2", kelas2, mapelKelas2, 2);
}

function renderKelasDiv(divId, dataSiswa, mapelList, kelas){
    const container = document.getElementById(divId);
    container.innerHTML = "";
    
    // Header Table
    let tableHtml = `<table class="input-table"><thead><tr>
                        <th class="no-cell" rowspan="2">No</th>
                        <th class="nama-cell" rowspan="2">NAMA</th>
                        ${mapelList.map(m => `<th colspan="3"><span class="mapel-title-rotated">${m.toUpperCase()}</span></th>`).join('')}
                        <th class="action-cell" rowspan="2">Aksi</th>
                    </tr><tr>
                        ${mapelList.map(() => peList.map(pe => `<th class="header-pe">${pe.replace('PE','')}</th>`).join('')).join('')}
                    </tr></thead><tbody>`;

    // Data Rows
    dataSiswa.forEach((s, index)=>{
        tableHtml += `<tr id="card-${s.nis}">
                        <td class="no-cell">${index + 1}</td>
                        <td class="nama-cell">${s.nama}</td>
                        ${mapelList.map(m => makeMapelInputCell(s.nis, m)).join('')}
                        <td class="action-cell">
                            <button class="btn btn-primary btn-sm mb-1" onclick="saveStudent('${s.nis}', ${JSON.stringify(mapelList)})">Simpan</button>
                            <button class="btn btn-outline-primary btn-sm" onclick="printStudent('${s.nis}')">Print</button>
                        </td>
                      </tr>`;
    });
    
    tableHtml += `</tbody></table>`;
    container.innerHTML = tableHtml;

    // after created, load stored values
    loadAllFromStorage();
}

/* make single mapel cell for one student, containing PE1, PE2, PE3 inputs */
function makeMapelInputCell(nis, mapel){
    const mid = sanitizeId(mapel);
    return `
        ${peList.map(pe => `
            <td class="mapel-cell">
                <div class="pe-input-group">
                    <div class="pe-item"> 
                        <label>${pe}</label>
                        <div id="inputs-${nis}-${mid}-${pe}">${makeSingleInput(nis, mapel, pe)}</div>
                        <button class="btn btn-sm btn-outline-secondary mt-1 w-100" style="display:none;" onclick="tambahNilai('${nis}','${mapel}','${pe}')">+ Nilai</button>
                    </div>
                </div>
            </td>
        `).join('')}
    `;
}


/* default 1 input element returned as html string */
function makeSingleInput(nis,mapel,pe){
    // Kita hanya perlu 1 input nilai di skema tabel baru ini, karena setiap PE punya kolom sendiri
    return `<input type="number" class="nilai-box" placeholder="-" maxlength="3" oninput="if(this.value.length>this.maxLength) this.value=this.value.slice(0,this.maxLength)" />`;
}

/* append new input to container - FUNGSI INI KINI TIDAK RELEVAN UNTUK FORMAT TABEL PE TUNGGAL */
function tambahNilai(nis,mapel,pe){
    alert('Fungsi tambah nilai dimatikan di format tabel. Hanya satu input per PE diperbolehkan.');
}

/* collect & save student's nilai to localStorage */
function saveStudent(nis, mapelList){
    const student = findStudentByNIS(nis);
    if(!student) return alert('Siswa tidak ditemukan.');

    const nilai = {};
    mapelList.forEach(mapel => {
        const mkey = mapel.trim();
        nilai[mkey] = {};
        peList.forEach(pe => {
            // Karena sekarang hanya ada SATU input per PE per Mapel:
            const container = document.getElementById(`inputs-${nis}-${sanitizeId(mapel)}-${pe}`);
            const input = container ? container.querySelector('input') : null;
            const vals = [];
            if(input){
                const v = input.value.trim();
                if(v !== '') vals.push(Number(v));
            }
            nilai[mkey][pe] = vals; // array of numbers (bisa kosong atau berisi 1 nilai)
        });
    });

    localStorage.setItem('nilai_'+nis, JSON.stringify({ siswa: student, nilai }));
    // visual feedback
    const btnContainer = document.querySelector(`#card-${nis} .action-cell`);
    const btns = btnContainer.querySelectorAll('.btn-primary');
    btns.forEach(b => {
        b.innerText = 'Tersimpan âœ“';
        setTimeout(()=> b.innerText = 'Simpan', 1100);
    });
}

/* load a student's stored nilai into inputs (if exist) */
function loadStudentToInputs(nis){
    const raw = localStorage.getItem('nilai_'+nis);
    if(!raw) return;
    try{
        const data = JSON.parse(raw);
        const nilai = data.nilai || {};
        const mapelList = kelas1.find(s=>s.nis===nis) ? mapelKelas1 : mapelKelas2;
        
        mapelList.forEach(mapel => {
            peList.forEach(pe => {
                const arr = nilai[mapel.trim()] && nilai[mapel.trim()][pe] ? nilai[mapel.trim()][pe] : [];
                const container = document.getElementById(`inputs-${nis}-${sanitizeId(mapel)}-${pe}`);
                if(!container) return;
                
                // Set nilai ke input tunggal
                const input = container.querySelector('input');
                if(input){
                    input.value = arr.length > 0 ? arr[0] : '';
                }
            });
        });
    } catch(e){ console.error(e); }
}

/* load all students from storage */
function loadAllFromStorage(){
    [...kelas1, ...kelas2].forEach(s => loadStudentToInputs(s.nis));
}

/* find student object by nis */
function findStudentByNIS(nis){
    return kelas1.find(s=>s.nis===nis) || kelas2.find(s=>s.nis===nis) || null;
}

/* =================== PRINT PER ORANG - KODE BARU DENGAN FASE B DAN TANPA TANGGAL CETAK =================== */

/* Create printable HTML for a student and open new window to print */
function printStudent(nis){
    const student = findStudentByNIS(nis);
    if(!student) return alert('Siswa tidak ditemukan.');

    // prefer stored data; if none, collect current inputs (so user can print unsaved changes)
    let saved = localStorage.getItem('nilai_'+nis);
    let obj;
    if(saved){
        obj = JSON.parse(saved);
    } else {
        // build nilai from current inputs
        const nilai = {};
        const mapelList = kelas1.find(s=>s.nis===nis) ? mapelKelas1 : mapelKelas2;
        mapelList.forEach(mapel => {
            nilai[mapel.trim()] = {};
            peList.forEach(pe => {
                const container = document.getElementById(`inputs-${nis}-${sanitizeId(mapel)}-${pe}`);
                const arr = [];
                if(container){
                    container.querySelectorAll('input').forEach(i => { if(i.value.trim() !== '') arr.push(Number(i.value)); });
                }
                nilai[mapel.trim()][pe] = arr;
            });
        });
        obj = { siswa: student, nilai };
    }

    // build HTML
    const win = window.open('','_blank','width=900,height=700');
    // NOTE: Gaya CSS untuk print sudah didefinisikan dalam tag <style> di atas
    const style = `<style>
            body{ font-family: Arial, Helvetica, sans-serif; padding:18px; color:#1f2937; }
            .print-header{ background: linear-gradient(90deg, #d9ecff 0%, #eef8ff 100%); padding:12px; border-radius:8px; text-align:center; margin-bottom:12px; border:1px solid #cfe8ff; color: #004d99; }
            h2{ margin:0; font-size:18px; color:#0f172a; }
            .meta{ margin-top:10px; display:grid; grid-template-columns: 1fr 1fr; gap:6px 22px; margin-bottom: 20px; }
            .meta .item{ font-size:14px; }
            .meta .label{ font-weight:700; width:110px; display:inline-block; }
            table{ width:100%; border-collapse:collapse; margin-top:12px; }
            table th, table td{ border:1px solid #99c2ff; padding:8px; text-align:left; font-size: 14px; }
            table thead th{ background: #b3d9ff; font-weight:700; text-align: center; }
            table td.mapel-col { width: 45%; text-align: left; }
            table td.nilai-col { width: 15%; text-align: center; }
            .signatures { display: flex; justify-content: space-between; margin-top: 40px; font-size: 14px; }
            .signature-box { text-align: center; width: 40%; }
            .signature-line { margin-top: 60px; border-bottom: 1px solid #333; display: inline-block; width: 100%; }
            @media print {
                body{ background: #fff; }
                table th, table td { border-color: #99c2ff; }
                table thead th { background: #b3d9ff; }
            }
        </style>
    `;

    // meta fields
    const semester = 'GANJIL';
    const fase = 'Fase B'; // <--- MODIFIKASI 1: Set Fase B
    const kelasSiswa = kelas1.find(s=>s.nis===nis) ? '1' : '2';
    
    // HTML Metadata
    const htmlMeta = `
        <div class="print-header">
            <h2>PEKAN EVALUASI SEMESTER GANJIL</h2>
        </div>
        <div class="meta">
            <div class="item"><span class="label">Nama</span>: ${student.nama}</div>
            <div class="item"><span class="label">Semester</span>: ${semester}</div>

            <div class="item"><span class="label">NIS</span>: ${student.nis}</div>
            <div class="item"><span class="label">Tahun Ajaran</span>: ${sekolah.tahunAjaran}</div>

            <div class="item"><span class="label">NISN</span>: ${student.nisn}</div>
            <div class="item"><span class="label">Nama Sekolah</span>: ${sekolah.nama}</div>

            <div class="item"><span class="label">Kelas</span>: ${kelasSiswa}</div>
            <div class="item"><span class="label">Alamat Sekolah</span>: ${sekolah.alamat}</div>

            <div class="item"><span class="label">Fase</span>: ${fase}</div>
            <div class="item"></div>
        </div>
    `;

    // build subjects table
    const nilai = obj.nilai || {};
    const mapelList = kelas1.find(s=>s.nis===nis) ? mapelKelas1 : mapelKelas2;
    const mapelKeys = mapelList.map(m => m.trim()).sort();
    
    let tableHtml = `<table><thead><tr>
                        <th style="width:5%">No</th>
                        <th class="mapel-col">MATA PELAJARAN</th>
                        <th class="nilai-col">PE 1</th>
                        <th class="nilai-col">PE 2</th>
                        <th class="nilai-col">PE 3</th>
                    </tr></thead><tbody>`;
    
    mapelKeys.forEach((mp, index)=>{
        const peObj = nilai[mp];
        
        // Ambil nilai pertama (karena format input sekarang tunggal)
        const pe1 = (peObj && peObj['PE1'] && peObj['PE1'].length) ? peObj['PE1'][0] : '-';
        const pe2 = (peObj && peObj['PE2'] && peObj['PE2'].length) ? peObj['PE2'][0] : '-';
        const pe3 = (peObj && peObj['PE3'] && peObj['PE3'].length) ? peObj['PE3'][0] : '-';

        tableHtml += `<tr>
                        <td style="text-align:center;">${index + 1}</td>
                        <td class="mapel-col">${mp}</td>
                        <td class="nilai-col">${pe1}</td>
                        <td class="nilai-col">${pe2}</td>
                        <td class="nilai-col">${pe3}</td>
                      </tr>`;
    });
    
    tableHtml += `</tbody></table>`;
    
    // Signature section 
    const signatureHtml = `
        <div class="signatures">
            <div class="signature-box">
                <p>TANDA TANGAN ORANG TUA</p>
                <div class="signature-line"></div>
            </div>
            <div class="signature-box">
                <p>TANDA TANGAN WALI KELAS</p>
                <div class="signature-line"></div>
            </div>
        </div>
    `;

    // final html - Baris small-note/tanggal cetak dihapus/tidak disertakan
    win.document.open();
    win.document.write(`<html><head><title>Print - ${student.nama}</title>${style}</head><body>${htmlMeta}${tableHtml}${signatureHtml}</body></html>`); // <--- MODIFIKASI 2: Dihilangkan
    win.document.close();

    // print after short delay to allow render
    setTimeout(()=> { win.print(); }, 400);
}

/* =================== INIT =================== */

renderTable();
renderInput();

</script>

</body>
</html>
