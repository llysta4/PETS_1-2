<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pekan Evaluasi - Van</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { font-family: Arial, sans-serif; background:#f8f9fa; }
  .nav-link { cursor:pointer; }
  .card-school { background:#fff; border:1px solid #e6e6e6; padding:12px; margin-bottom:12px; }
  .pe-value { width:110px; display:inline-block; margin-right:6px; }
  .small-btn { padding: .2rem .45rem; font-size: .8rem; }
  /* Print layout styles */
  .print-layout { display:none; }
  @media print {
    body * { visibility:hidden; }
    .print-layout, .print-layout * { visibility:visible; }
    .print-layout { position:absolute; left:0; top:0; width:100%; font-size:11pt; }
    .print-layout table { width:100%; border-collapse:collapse; }
    .print-layout th, .print-layout td { border:1px solid #000; padding:6px; vertical-align:top; }
    .print-layout h2 { text-align:center; color:#0d6efd; text-transform:uppercase; font-size:1.05rem; }
  }
</style>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
  <div class="container-fluid">
    <a class="navbar-brand">PEKAN EVALUASI SEMESTER GANJIL</a>
    <div class="d-flex">
      <button class="btn btn-light me-2" onclick="showPage('pageData')">Halaman 1 - Data & Print</button>
      <button class="btn btn-light" onclick="showPage('pageInput')">Halaman 2 - Input Nilai</button>
    </div>
  </div>
</nav>

<!-- PAGE 1: DATA & PRINT -->
<div id="pageData" class="container mt-4">
  <!-- Identitas Sekolah otomatis -->
  <div class="card-school">
    <div><strong>Nama Sekolah:</strong> SD NEGERI CONTOH 01</div>
    <div><strong>Alamat:</strong> Jl. Pendidikan No. 12</div>
    <div><strong>Tahun Ajaran:</strong> 2025 / 2026</div>
  </div>

  <h5 class="mb-3">Kelas 1</h5>
  <table class="table table-bordered table-striped">
    <thead class="table-primary">
      <tr><th>No Absen</th><th>Nama</th><th>NIS</th><th>NISN</th><th>Aksi</th></tr>
    </thead>
    <tbody id="tableKelas1"></tbody>
  </table>

  <h5 class="mt-4 mb-3">Kelas 2</h5>
  <table class="table table-bordered table-striped">
    <thead class="table-primary">
      <tr><th>No Absen</th><th>Nama</th><th>NIS</th><th>NISN</th><th>Aksi</th></tr>
    </thead>
    <tbody id="tableKelas2"></tbody>
  </table>
</div>

<!-- PAGE 2: INPUT NILAI (6 siswa) -->
<div id="pageInput" class="container mt-4" style="display:none;">
  <div class="card-school">
    <strong>Nama Sekolah:</strong> SD NEGERI CONTOH 01 &nbsp; | &nbsp;
    <strong>Alamat:</strong> Jl. Pendidikan No. 12 &nbsp; | &nbsp;
    <strong>Tahun Ajaran:</strong> 2025 / 2026
  </div>

  <div class="mb-3 d-flex justify-content-between">
    <div><strong>Catatan:</strong> Setiap mapel punya PE1, PE2, PE3. Klik "+ Nilai" untuk menambahkan nilai lebih dari satu.</div>
    <div><button class="btn btn-success" onclick="saveAll()">Simpan Semua</button></div>
  </div>

  <!-- KELAS 1 SECTION -->
  <div class="mb-4">
    <h5 class="text-primary">KELAS 1 (3 siswa) — 10 Mapel</h5>
    <div id="kelas1Inputs"></div>
  </div>

  <!-- KELAS 2 SECTION -->
  <div class="mb-4">
    <h5 class="text-primary">KELAS 2 (3 siswa) — 11 Mapel</h5>
    <div id="kelas2Inputs"></div>
  </div>
</div>

<!-- PRINT LAYOUT (injected then printed) -->
<div id="printLayout" class="print-layout"></div>

<script>
/* ---------- INITIAL DATA (dari input kamu) ---------- */
const schoolInfo = {
  namaSekolah: "SD NEGERI CONTOH 01",
  alamat: "Jl. Pendidikan No. 12",
  tahunAjaran: "2025 / 2026"
};

const mapelK1 = [
  "PENDIDIKAN AGAMA DAN BUDI PEKERTI",
  "PENDIDIKAN PANCASILA",
  "BAHASA INDONESIA",
  "MATEMATIKA",
  "PJOK",
  "SENI BUDAYA DAN PRAKARYA",
  "BAHASA SUNDA",
  "PENDIDIKAN LINGKUNGAN HIDUP",
  "BAHASA INGGRIS",
  "TIK"
];

const mapelK2 = [
  "PENDIDIKAN AGAMA DAN BUDI PEKERTI",
  "PENDIDIKAN PANCASILA",
  "BAHASA INDONESIA",
  "MATEMATIKA",
  "PJOK",
  "SENI BUDAYA DAN PRAKARYA",
  "BAHASA SUNDA",
  "PENDIDIKAN LINGKUNGAN HIDUP",
  "BAHASA INGGRIS",
  "TIK",
  "PRAMUKA"
];

/* Siswa (terisi otomatis dari data pesanmu) */
/* Perhatikan: jika NISN kosong, diset '' */
let students = [
  // Kelas 1
  { kelas:1, no:1, nama:"KHENSI RAFALDI PRIYADI", nis:"252601001", nisn:"", mapel: [] },
  { kelas:1, no:2, nama:"KIMBERLY BELLVANIA HERYANTO", nis:"252601002", nisn:"317378079", mapel: [] },
  { kelas:1, no:3, nama:"YOSIA CHARISDEO DEIS", nis:"252601008", nisn:"", mapel: [] },
  // Kelas 2
  { kelas:2, no:1, nama:"STELLA ANGELINA YANUBI", nis:"242501003", nisn:"3176946273", mapel: [] },
  { kelas:2, no:2, nama:"FADHIL BAYU AQIRIN", nis:"252602006", nisn:"", mapel: [] },
  { kelas:2, no:3, nama:"GWYNETH TANUWIDJAJA", nis:"252602004", nisn:"3169999681", mapel: [] }
];

// load saved data from localStorage if exist (keutamaan)
const saved = localStorage.getItem("pe_students_v1");
if (saved) {
  try { students = JSON.parse(saved); }
  catch(e){ /* ignore parse */ }
} else {
  // initialize mapel arrays empty values
  students.forEach(s => {
    const list = s.kelas === 1 ? mapelK1 : mapelK2;
    s.mapel = list.map(m => ({ nama: m, pe1: [], pe2: [], pe3: [] }));
  });
}

/* ---------- UI RENDER ---------- */

function showPage(id){
  document.getElementById("pageData").style.display = id === "pageData" ? "block" : "none";
  document.getElementById("pageInput").style.display = id === "pageInput" ? "block" : "none";
  if(id==="pageData") renderTables();
  if(id==="pageInput") renderInputs();
}

/* Render page 1 tables */
function renderTables(){
  const t1 = document.getElementById("tableKelas1");
  const t2 = document.getElementById("tableKelas2");
  t1.innerHTML = ""; t2.innerHTML = "";
  students.filter(s=>s.kelas===1).forEach((s,idx)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${s.no}</td>
      <td>${s.nama}</td>
      <td>${s.nis}</td>
      <td>${s.nisn || '-'}</td>
      <td>
        <button class="btn btn-sm btn-warning me-1" onclick="goToInput(${getStudentIndex(s)})">Input</button>
        <button class="btn btn-sm btn-info" onclick="printStudent(${getStudentIndex(s)})">Print</button>
      </td>`;
    t1.appendChild(tr);
  });
  students.filter(s=>s.kelas===2).forEach((s,idx)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${s.no}</td>
      <td>${s.nama}</td>
      <td>${s.nis}</td>
      <td>${s.nisn || '-'}</td>
      <td>
        <button class="btn btn-sm btn-warning me-1" onclick="goToInput(${getStudentIndex(s)})">Input</button>
        <button class="btn btn-sm btn-info" onclick="printStudent(${getStudentIndex(s)})">Print</button>
      </td>`;
    t2.appendChild(tr);
  });
}

/* Render page 2 inputs for all 6 students */
function renderInputs(){
  const k1 = document.getElementById("kelas1Inputs");
  const k2 = document.getElementById("kelas2Inputs");
  k1.innerHTML = ""; k2.innerHTML = "";

  students.filter(s=>s.kelas===1).forEach((s,si)=>{
    k1.appendChild(renderStudentInputCard(s, getStudentIndex(s)));
  });
  students.filter(s=>s.kelas===2).forEach((s,si)=>{
    k2.appendChild(renderStudentInputCard(s, getStudentIndex(s)));
  });
}

/* helper to create input card for a student */
function renderStudentInputCard(student, idx){
  const card = document.createElement("div");
  card.className = "card mb-3 p-3";
  const header = document.createElement("div");
  header.innerHTML = `<strong>${student.no}. ${student.nama} (Kelas ${student.kelas})</strong>
    <div class="text-muted small">NIS: ${student.nis} &nbsp;|&nbsp; NISN: ${student.nisn||'-'}</div>`;
  card.appendChild(header);

  const table = document.createElement("div");
  table.className = "mt-3";

  // for each mapel
  student.mapel.forEach((m, mi) => {
    const mapelDiv = document.createElement("div");
    mapelDiv.className = "mb-3";
    mapelDiv.innerHTML = `<div class="fw-semibold">${mi+1}. ${m.nama}</div>`;
    // PE1
    const pe1Div = document.createElement("div");
    pe1Div.className = "mt-1";
    pe1Div.innerHTML = `<span class="me-2">PE 1:</span> <span id="s-${idx}-m-${mi}-pe1"></span>
      <button class="btn btn-sm btn-outline-primary small-btn" onclick="addValue(${idx}, ${mi}, 'pe1')">+ Nilai</button>`;
    mapelDiv.appendChild(pe1Div);

    // PE2
    const pe2Div = document.createElement("div");
    pe2Div.className = "mt-1";
    pe2Div.innerHTML = `<span class="me-2">PE 2:</span> <span id="s-${idx}-m-${mi}-pe2"></span>
      <button class="btn btn-sm btn-outline-primary small-btn" onclick="addValue(${idx}, ${mi}, 'pe2')">+ Nilai</button>`;
    mapelDiv.appendChild(pe2Div);

    // PE3
    const pe3Div = document.createElement("div");
    pe3Div.className = "mt-1";
    pe3Div.innerHTML = `<span class="me-2">PE 3:</span> <span id="s-${idx}-m-${mi}-pe3"></span>
      <button class="btn btn-sm btn-outline-primary small-btn" onclick="addValue(${idx}, ${mi}, 'pe3')">+ Nilai</button>`;
    mapelDiv.appendChild(pe3Div);

    table.appendChild(mapelDiv);
  });

  card.appendChild(table);

  // Populate existing values
  setTimeout(()=> populateStudentValueSpans(idx), 0);

  return card;
}

/* get index in students array by object reference */
function getStudentIndex(studentObj){
  return students.indexOf(studentObj);
}

/* add an input value to a student's mapel.peX */
function addValue(studentIdx,
